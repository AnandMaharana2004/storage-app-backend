name: Backend Deployment to EC2

on:
  push:
    branches:
      - main
      # - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ubuntu
      REMOTE_APP_DIR: /home/ubuntu/storage-app-backend
      PM2_ECOSYSTEM_FILE: ecosystem.config.cjs

    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "SSH key setup completed"

      - name: Add Host to Known Hosts
        run: |
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
          echo "Host $SSH_HOST added to known_hosts"

      - name: Test SSH Connection
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" 'echo "SSH connection successful" && uname -a'

      - name: Check if App Directory Exists
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "test -d $REMOTE_APP_DIR && echo 'Directory exists' || echo 'Directory does not exist'"

      - name: Check if Git Repository
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "cd $REMOTE_APP_DIR && git rev-parse --git-dir && echo 'Valid git repository' || echo 'Not a git repository'"

      - name: Stash Local Changes
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "cd $REMOTE_APP_DIR && (git stash || true) && echo 'Checked for local changes'"

      - name: Pull Latest Code
        id: git-pull
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "cd $REMOTE_APP_DIR && git pull origin main && echo 'Git pull completed'"

      - name: Install Production Dependencies
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "cd $REMOTE_APP_DIR && npm ci --omit=dev --no-audit --no-fund && echo 'Production dependencies installed'"

      - name: Start/Reload PM2 Apps
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "cd $REMOTE_APP_DIR && pm2 startOrReload $PM2_ECOSYSTEM_FILE --update-env && pm2 save && echo 'PM2 apps started/reloaded and saved successfully'"

      - name: Verify Deployment
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "pm2 status && echo 'Deployment verification completed'"

      - name: Deployment Success
        run: |
          echo "Backend deployed successfully to EC2!"

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "Deployment failed! Attempting rollback..."
          ssh "${SSH_USER}@${SSH_HOST}" "cd $REMOTE_APP_DIR && git reset --hard HEAD@{1} && pm2 reload all && echo 'Rollback completed'"
